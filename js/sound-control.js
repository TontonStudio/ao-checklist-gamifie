/**
 * Contr√¥leur de son centralis√© optimis√©
 * G√®re la lecture et la mise en sourdine des sons d'avertissement
 */
const SoundControl = {
  // √âtat du son (d√©sactiv√© ou non)
  muted: false,
  
  // R√©f√©rence aux √©l√©ments audio (charg√©s une seule fois)
  warningSound: null,
  soundButton: null,
  
  // Cache pour l'√©cran de checklist
  checklistScreen: null,
  
  // Cl√© pour le localStorage
  STORAGE_KEY: 'tontonAoMusicMuted',
  
  // √âtat actif de la musique d'avertissement
  warningActive: false,
  
  // Variables pour le fade out
  fadeInterval: null,
  
  /**
   * Initialise le contr√¥leur de son
   */
  init: function() {
    // Mettre en cache les √©l√©ments DOM une seule fois
    this.warningSound = document.getElementById('warning-sound');
    this.soundButton = document.getElementById('sound-toggle');
    this.checklistScreen = document.getElementById('checklist-screen');
    
    // Pr√©charger le son d'avertissement pour √©viter les d√©lais
    if (this.warningSound) {
      this.warningSound.preload = 'auto';
      this.warningSound.load();
    }
    
    // Charger l'√©tat du son depuis localStorage
    this.loadMuteState();
    
    // Configurer le bouton de contr√¥le du son s'il existe
    if (this.soundButton) {
      // Masquer le bouton initialement
      this.soundButton.style.display = 'none';
      
      // Mettre √† jour l'apparence selon l'√©tat du son
      this.updateButtonAppearance();
      
      // Ajouter un gestionnaire d'√©v√©nement pour le clic
      this.soundButton.addEventListener('click', () => {
        this.toggleMute();
      });
    }
    
    // Cr√©er un attribut personnalis√© sur document.body pour indiquer l'√©tat du son (utile pour CSS)
    document.body.setAttribute('data-sound-muted', this.muted.toString());
  },
  
  /**
   * Charge l'√©tat du son depuis localStorage
   */
  loadMuteState: function() {
    try {
      const savedState = localStorage.getItem(this.STORAGE_KEY);
      if (savedState !== null) {
        this.muted = savedState === 'true';
      }
    } catch (e) {
      // En cas d'erreur localStorage (ex: navigation priv√©e), continuer avec l'√©tat par d√©faut
      this.muted = false;
    }
  },
  
  /**
   * Sauvegarde l'√©tat du son dans localStorage
   */
  saveMuteState: function() {
    try {
      localStorage.setItem(this.STORAGE_KEY, this.muted);
    } catch (e) {
      // Ignorer les erreurs de localStorage
    }
  },
  
  /**
   * Met √† jour l'apparence du bouton de son
   */
  updateButtonAppearance: function() {
    if (!this.soundButton) return;
    
    // Utiliser requestAnimationFrame pour les changements DOM
    requestAnimationFrame(() => {
      // Mettre √† jour l'ic√¥ne et le titre en une seule op√©ration
      this.soundButton.textContent = this.muted ? 'üîá' : 'üîä';
      this.soundButton.title = this.muted ? 'Activer le son' : 'Couper le son';
      
      // Utiliser un attribut data pour le style CSS
      this.soundButton.setAttribute('data-muted', this.muted);
      document.body.setAttribute('data-sound-muted', this.muted.toString());
    });
  },
  
  /**
   * Active ou d√©sactive le son (fonctionne comme un bouton pause/play)
   */
  toggleMute: function() {
    // Inverser l'√©tat du son
    this.muted = !this.muted;
    
    // Sauvegarder le nouvel √©tat
    this.saveMuteState();
    
    // Mettre √† jour l'apparence du bouton
    this.updateButtonAppearance();
    
    // Appliquer l'√©tat du son
    if (this.muted) {
      // Si on d√©sactive le son, mettre la musique en pause (sans reset)
      if (this.warningSound && !this.warningSound.paused) {
        try {
          this.warningSound.pause();
        } catch (e) {
          // Ignorer les erreurs potentielles
        }
      }
    } else if (this.warningActive) {
      // Si on active le son et qu'on est en mode warning, jouer la musique
      // Utiliser false pour fromStart pour reprendre l√† o√π on en √©tait
      this.playWarningSound(false);
    }
  },
  
  /**
   * Active le mode warning et joue la musique si n√©cessaire
   */
  activateWarningMode: function() {
    // √âviter les activations redondantes
    if (this.warningActive) return;
    
    // Marquer le mode warning comme actif
    this.warningActive = true;
    
    // Afficher le bouton de contr√¥le du son
    this.showSoundButton();
    
    // Jouer la musique d'avertissement si le son n'est pas d√©sactiv√©
    if (!this.muted) {
      // Utiliser un court d√©lai pour √©viter les conflits d'op√©rations audio
      setTimeout(() => this.playWarningSound(), 50);
    }
  },
  
  /**
   * D√©sactive le mode warning et arr√™te la musique
   */
  deactivateWarningMode: function() {
    // √âviter les d√©sactivations redondantes
    if (!this.warningActive) return;
    
    // Marquer le mode warning comme inactif
    this.warningActive = false;
    
    // Masquer le bouton de contr√¥le du son
    this.hideSoundButton();
    
    // Arr√™ter la musique d'avertissement et r√©initialiser la position
    // On utilise true pour resetPosition car on quitte compl√®tement le mode warning
    this.stopWarningSound(false, true);
  },
  
  /**
   * Joue la musique d'avertissement avec optimisations
   * @param {boolean} fromStart - Si vrai, d√©marre la lecture depuis le d√©but (d√©faut: true)
   */
  playWarningSound: function(fromStart = true) {
    // Ne pas jouer si le son est d√©sactiv√©, si on n'est pas en mode warning, ou si l'√©l√©ment n'existe pas
    if (this.muted || !this.warningActive || !this.warningSound) {
      if (APP_CONFIG.debug) {
        console.log("Impossible de jouer le son d'avertissement:", {
          muted: this.muted,
          warningActive: this.warningActive,
          warningSound: !!this.warningSound
        });
      }
      return;
    }
    
    // Si le son est d√©j√† en cours de lecture et n'est pas en pause, ne rien faire
    if (this.warningSound.currentTime > 0 && !this.warningSound.paused) return;
    
    // Nettoyer tout fade out en cours
    if (this.fadeInterval) {
      clearInterval(this.fadeInterval);
      this.fadeInterval = null;
    }
    
    // S'assurer que l'√©l√©ment audio est correctement configur√©
    this.warningSound.preload = 'auto';
    this.warningSound.volume = 0.3;
    this.warningSound.loop = true;
    this.warningSound.muted = false; // S'assurer que le son n'est pas en sourdine
    
    // Afficher le bouton de son pour garantir qu'il est visible
    this.showSoundButton();
    
    // Tenter de lire le son avec gestion optimis√©e des erreurs
    try {
      // Si on doit d√©marrer la musique depuis le d√©but
      if (fromStart) {
        this.warningSound.pause();
        this.warningSound.currentTime = 0;
      }
      
      const playPromise = this.warningSound.play();
      
      // G√©rer uniquement les promesses d√©finies (certains navigateurs ne renvoient pas de promesse)
      if (playPromise !== undefined) {
        playPromise.catch((error) => {
          // Si la lecture automatique est bloqu√©e, tenter une autre approche apr√®s un court d√©lai
          if (APP_CONFIG.debug) {
            console.warn("Erreur lors de la lecture du son d'avertissement:", error);
          }
          
          if (!this.muted && this.warningActive) {
            // Reporter la tentative pour √©viter de spammer les erreurs
            setTimeout(() => this.tryUnblockAudio(), 500);
          }
        });
      }
    } catch (e) {
      // G√©rer les erreurs de lecture audio (tr√®s rares)
      if (APP_CONFIG.debug) {
        console.warn('Erreur de lecture audio :', e);
      }
    }
  },
  
  /**
   * Arr√™te la musique d'avertissement avec optimisations
   * @param {boolean} fadeOut - Si vrai, effectue un fade out de la musique
   * @param {boolean} resetPosition - Si vrai, r√©initialise la position de lecture (d√©faut: false)
   */
  stopWarningSound: function(fadeOut = false, resetPosition = false) {
    // V√©rifications rapides pour √©viter les op√©rations inutiles
    if (!this.warningSound || this.warningSound.paused) return;
    
    // Nettoyer tout fade out en cours
    if (this.fadeInterval) {
      clearInterval(this.fadeInterval);
      this.fadeInterval = null;
    }
    
    if (fadeOut) {
      // Effectuer un fade out progressif optimis√©
      const initialVolume = this.warningSound.volume;
      
      // Utiliser moins d'√©tapes pour plus d'efficacit√©
      const fadeSteps = 10; // R√©duit de 20 √† 10
      const volumeStep = initialVolume / fadeSteps;
      const stepDuration = 100; // 100ms par √©tape (total 1s)
      
      let currentStep = 0;
      
      this.fadeInterval = setInterval(() => {
        currentStep++;
        
        // Appliquer le nouveau volume avec v√©rification de s√©curit√©
        const newVolume = Math.max(0, initialVolume - (volumeStep * currentStep));
        
        try {
          this.warningSound.volume = newVolume;
        } catch (e) {
          // Ignorer les erreurs potentielles de modification de volume
        }
        
        // Quand le fade est complet
        if (currentStep >= fadeSteps) {
          clearInterval(this.fadeInterval);
          this.fadeInterval = null;
          
          // Arr√™ter le son et r√©initialiser le volume
          try {
            this.warningSound.pause();
            
            // Ne r√©initialiser la position que si demand√©
            if (resetPosition) {
              this.warningSound.currentTime = 0;
            }
            
            this.warningSound.volume = initialVolume; // Restaurer le volume
          } catch (e) {
            // Ignorer les erreurs potentielles
          }
        }
      }, stepDuration);
    } else {
      // Arr√™t imm√©diat plus s√ªr
      try {
        this.warningSound.pause();
        
        // Ne r√©initialiser la position que si demand√©
        if (resetPosition) {
          this.warningSound.currentTime = 0;
        }
      } catch (e) {
        // Ignorer les erreurs potentielles
      }
    }
  },
  
  /**
   * Affiche le bouton de contr√¥le du son avec optimisations
   */
  showSoundButton: function() {
    // V√©rification rapide pour √©viter les op√©rations DOM inutiles
    if (!this.soundButton || !this.isChecklist()) return;
    
    // Afficher le bouton en une seule op√©ration
    requestAnimationFrame(() => {
      this.soundButton.style.display = 'flex';
      this.soundButton.style.visibility = 'visible'; // S'assurer que le bouton est aussi visible
      this.soundButton.style.opacity = '0.95'; // S'assurer que l'opacit√© est correcte
      this.updateButtonAppearance();
    });
  },
  
  /**
   * Masque le bouton de contr√¥le du son
   */
  hideSoundButton: function() {
    if (!this.soundButton) return;
    
    requestAnimationFrame(() => {
      this.soundButton.style.display = 'none';
    });
  },
  
  /**
   * V√©rifie si on est sur l'√©cran de checklist (optimis√©)
   * @returns {boolean} - true si on est sur l'√©cran de checklist
   */
  isChecklist: function() {
    return this.checklistScreen && this.checklistScreen.style.display !== 'none';
  },
  
  /**
   * Tente de d√©bloquer l'audio pour les navigateurs restrictifs
   */
  tryUnblockAudio: function() {
    // √âviter les tentatives multiples
    if (!this.warningActive || this.muted) return;
    
    try {
      // M√©thode plus l√©g√®re pour tenter de d√©bloquer l'audio
      const temp = new Audio();
      temp.autoplay = true;
      temp.volume = 0;
      temp.src = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA";
      
      // Lecture silencieuse
      const promise = temp.play();
      if (promise !== undefined) {
        promise.then(() => {
          // Si la lecture silencieuse r√©ussit, tenter de jouer le son d'avertissement
          setTimeout(() => {
            if (this.warningActive && !this.muted) {
              this.playWarningSound();
            }
          }, 100);
        }).catch(() => {
          // Si la lecture silencieuse √©choue, ne rien faire de plus
        }).finally(() => {
          // Nettoyer
          temp.onended = null;
          temp.onerror = null;
          temp.oncanplaythrough = null;
        });
      }
    } catch(e) {
      // Ignorer les erreurs
    }
  }
};

// Initialisation optimis√©e pour √©viter les blocages de rendu
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    // Initialiser apr√®s un court d√©lai pour ne pas bloquer le rendu initial
    setTimeout(() => SoundControl.init(), 100);
  });
} else {
  // Si le DOM est d√©j√† charg√©, initialiser pendant une p√©riode d'inactivit√©
  requestIdleCallback ? requestIdleCallback(() => SoundControl.init()) : setTimeout(() => SoundControl.init(), 100);
}